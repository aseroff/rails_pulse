<% global_filters = session_global_filters %>
<% has_global_filters = global_filters['start_time'].present? && global_filters['end_time'].present? %>
<% has_performance_filter = global_filters['performance_threshold'].present? %>
<% disabled_tags = global_filters['disabled_tags'] || [] %>
<% has_tag_filters = disabled_tags.any? %>
<% has_any_filters = has_global_filters || has_performance_filter  %>
<% current_date_range = has_global_filters ? "#{global_filters['start_time']} to #{global_filters['end_time']}" : "" %>
<% current_threshold = global_filters['performance_threshold'] %>

<div data-controller="rails-pulse--global-filters" data-rails-pulse--global-filters-active-value="<%= has_any_filters %>">
  <%= link_to '#', "aria-label": "Global filters", role: "button", data: { action: "rails-pulse--global-filters#open", "rails-pulse--global-filters-target": "indicator" } do %>
    <%= rails_pulse_icon has_any_filters ? 'list-filter-plus' : 'list-filter', width: '20' %>
  <% end %>

  <div data-rails-pulse--global-filters-target="wrapper" data-action="click->rails-pulse--global-filters#closeOnClickOutside" style="display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div class="dialog" data-rails-pulse--global-filters-target="dialog" style="position: relative; opacity: 1; transform: scale(1);">
      <div class="dialog__content">
        <h2 class="text-lg font-semibold mb-4">Global Filters</h2>
        <p class="text-sm text-subtle mb-4">Set default time filters that persist across all pages. These can be overridden by page-specific filters.</p>

        <%= form_with url: settings_global_filters_path, method: :patch, local: true, data: { action: "submit->rails-pulse--global-filters#submit" } do |form| %>
          <div class="flex flex-col gap mb-4">
            <div class="flex flex-col gap" style="--row-gap: 0.5rem">
              <label for="global_date_range" class="text-sm font-medium">Date Range</label>
              <input
                type="text"
                name="date_range"
                id="global_date_range"
                value="<%= current_date_range %>"
                placeholder="Pick date range"
                class="input"
                data-controller="rails-pulse--datepicker"
                data-rails-pulse--datepicker-mode-value="range"
                data-rails-pulse--datepicker-show-months-value="2"
                data-rails-pulse--datepicker-type-value="datetime"
                data-rails-pulse--global-filters-target="dateRange"
              />
            </div>

            <div class="flex flex-col gap" style="--row-gap: 0.5rem">
              <label for="global_performance_threshold" class="text-sm font-medium">Performance Threshold</label>
              <select name="performance_threshold" id="global_performance_threshold" class="input">
                <option value="">All Requests</option>
                <option value="slow" <%= 'selected' if current_threshold == 'slow' %>>Slow and Above</option>
                <option value="very_slow" <%= 'selected' if current_threshold == 'very_slow' %>>Very Slow and Above</option>
                <option value="critical" <%= 'selected' if current_threshold == 'critical' %>>Critical Only</option>
              </select>
              <p class="text-xs text-subtle">Filter requests/queries by performance threshold</p>
            </div>

            <div class="flex flex-col gap" style="--row-gap: 0.5rem">
              <label class="text-sm font-medium">Tag Visibility</label>
              <p class="text-xs text-subtle">Toggle visibility of tagged data. Unchecked tags will be hidden from all views.</p>
              <div class="flex flex-col gap" style="--row-gap: 0.75rem">
                <% tags = RailsPulse.configuration.tags + ["non_tagged"] %>
                <% tags.each do |tag| %>
                  <div class="flex items-center gap">
                    <input
                      type="checkbox"
                      name="enabled_tags[]"
                      id="tag_<%= tag %>"
                      value="<%= tag %>"
                      <%= 'checked="checked"' if tag == "non_tagged" ? session[:show_non_tagged] != false : !disabled_tags.include?(tag) %>
                      class="switch"
                      role="switch"
                    />
                    <label class="text-sm font-medium" for="tag_<%= tag %>">
                      <%= tag.humanize %>
                    </label>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-end gap">
            <%= form.button "Clear", type: "submit", name: "clear", value: "true", class: "btn btn--borderless", formnovalidate: true %>
            <%= form.submit "Apply Filters", class: "btn" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
