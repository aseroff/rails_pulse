<div popover class="popover card operation-details-popover">
  <div class="operation-details-container">
    <div class="operation-details-header">
      <h3 class="operation-details-title">
        <%= operation.operation_type.upcase %> Operation
      </h3>
      <span class="badge" style="background-color: <%= event_color(operation.operation_type) %>15; color: <%= event_color(operation.operation_type) %>;">
        <%= operation.duration.round(2) %>ms
      </span>
    </div>

    <div class="operation-details-content">
      <div>
        <h4 class="operation-detail-label">Label</h4>
        <div class="operation-detail-value operation-detail-code">
          <%= operation.label %>
        </div>
      </div>

      <% if operation.occurred_at.present? %>
        <div>
          <h4 class="operation-detail-label">Occurred At</h4>
          <div class="operation-detail-value">
            <%= operation.occurred_at.strftime("%H:%M:%S.%L") %>
          </div>
        </div>
      <% end %>

      <% case operation.operation_type %>
      <% when "sql" %>
        <div>
          <h4 class="operation-detail-label">Performance Notes</h4>
          <div class="operation-detail-value operation-performance-notes">
            <% if operation.duration > 100 %>
              <div class="operation-warning"><%= lucide_icon 'triangle-alert', width: '16', class: 'inline-block' %> Slow query (>100ms)</div>
            <% elsif operation.duration > 50 %>
              <div class="operation-moderate">âš¡ Moderate query (>50ms)</div>
            <% else %>
              <div class="operation-success"><%= lucide_icon 'check', width: '16', class: 'inline-block' %> Fast query</div>
            <% end %>

            <% if operation.query.present? %>
              <div class="operation-detail-note">
                Query normalized for tracking
              </div>
            <% end %>
          </div>
        </div>

        <% if operation.label&.match?(/SELECT.*FROM\s+(\w+)/i) %>
          <div>
            <h4 class="text-xs font-medium text-subtle uppercase tracking-wide mb-1">Table</h4>
            <div class="text-sm font-mono bg-blue-50 p-2 rounded border">
              <%= operation.label.match(/FROM\s+(\w+)/i)&.captures&.first || "Unknown" %>
            </div>
          </div>
        <% end %>

      <% when "controller" %>
        <div>
          <h4 class="text-xs font-medium text-subtle uppercase tracking-wide mb-1">Action Info</h4>
          <div class="text-sm space-y-1">
            <% if operation.duration > 500 %>
              <div class="text-red-600"><%= lucide_icon 'triangle-alert', width: '16', class: 'inline-block' %> Slow action (>500ms)</div>
            <% elsif operation.duration > 200 %>
              <div class="text-orange-600">âš¡ Moderate action (>200ms)</div>
            <% else %>
              <div class="text-green-600"><%= lucide_icon 'check', width: '16', class: 'inline-block' %> Fast action</div>
            <% end %>
            <div class="text-xs text-subtle">
              Controller action processing time
            </div>
          </div>
        </div>

      <% when "template", "partial", "layout", "collection" %>
        <div>
          <h4 class="text-xs font-medium text-subtle uppercase tracking-wide mb-1">View Performance</h4>
          <div class="text-sm space-y-1">
            <% if operation.duration > 100 %>
              <div class="text-red-600"><%= lucide_icon 'triangle-alert', width: '16', class: 'inline-block' %> Slow render (>100ms)</div>
            <% elsif operation.duration > 50 %>
              <div class="text-orange-600">âš¡ Moderate render (>50ms)</div>
            <% else %>
              <div class="text-green-600"><%= lucide_icon 'check', width: '16', class: 'inline-block' %> Fast render</div>
            <% end %>
            <div class="text-xs text-subtle">
              <%= operation.operation_type.capitalize %> rendering time
            </div>
          </div>
        </div>

        <% if operation.codebase_location.present? %>
          <div>
            <h4 class="text-xs font-medium text-subtle uppercase tracking-wide mb-1">File Location</h4>
            <div class="text-xs font-mono bg-gray-50 p-2 rounded border text-wrap break-all">
              <%= operation.codebase_location.split('/').last(3).join('/') %>
            </div>
          </div>
        <% end %>

      <% when "cache_read", "cache_write" %>
        <div>
          <h4 class="text-xs font-medium text-subtle uppercase tracking-wide mb-1">Cache Performance</h4>
          <div class="text-sm space-y-1">
            <% if operation.operation_type == "cache_read" %>
              <% if operation.duration > 10 %>
                <div class="text-orange-600">âš¡ Slow cache read (>10ms)</div>
              <% else %>
                <div class="text-green-600"><%= lucide_icon 'check', width: '16', class: 'inline-block' %> Fast cache read</div>
              <% end %>
            <% else %>
              <% if operation.duration > 50 %>
                <div class="text-orange-600">âš¡ Slow cache write (>50ms)</div>
              <% else %>
                <div class="text-green-600"><%= lucide_icon 'check', width: '16', class: 'inline-block' %> Fast cache write</div>
              <% end %>
            <% end %>
            <div class="text-xs text-subtle">
              <%= operation.operation_type.humanize %> operation
            </div>
          </div>
        </div>

      <% when "http" %>
        <div>
          <h4 class="text-xs font-medium text-subtle uppercase tracking-wide mb-1">HTTP Request</h4>
          <div class="text-sm space-y-1">
            <% if operation.duration > 1000 %>
              <div class="text-red-600"><%= lucide_icon 'triangle-alert', width: '16', class: 'inline-block' %> Very slow request (>1s)</div>
            <% elsif operation.duration > 500 %>
              <div class="text-orange-600">âš¡ Slow request (>500ms)</div>
            <% else %>
              <div class="text-green-600"><%= lucide_icon 'check', width: '16', class: 'inline-block' %> Fast request</div>
            <% end %>
            <div class="text-xs text-subtle">
              External HTTP request duration
            </div>
          </div>
        </div>

      <% when "job" %>
        <div>
          <h4 class="text-xs font-medium text-subtle uppercase tracking-wide mb-1">Background Job</h4>
          <div class="text-sm space-y-1">
            <% if operation.duration > 5000 %>
              <div class="text-red-600"><%= lucide_icon 'triangle-alert', width: '16', class: 'inline-block' %> Long-running job (>5s)</div>
            <% elsif operation.duration > 1000 %>
              <div class="text-orange-600">âš¡ Moderate job (>1s)</div>
            <% else %>
              <div class="text-green-600"><%= lucide_icon 'check', width: '16', class: 'inline-block' %> Quick job</div>
            <% end %>
            <div class="text-xs text-subtle">
              Active Job execution time
            </div>
          </div>
        </div>

      <% when "mailer" %>
        <div>
          <h4 class="text-xs font-medium text-subtle uppercase tracking-wide mb-1">Email Delivery</h4>
          <div class="text-sm space-y-1">
            <% if operation.duration > 2000 %>
              <div class="text-red-600"><%= lucide_icon 'triangle-alert', width: '16', class: 'inline-block' %> Slow email delivery (>2s)</div>
            <% elsif operation.duration > 500 %>
              <div class="text-orange-600">âš¡ Moderate delivery (>500ms)</div>
            <% else %>
              <div class="text-green-600"><%= lucide_icon 'check', width: '16', class: 'inline-block' %> Fast delivery</div>
            <% end %>
            <div class="text-xs text-subtle">
              ActionMailer delivery time
            </div>
          </div>
        </div>

      <% when "storage" %>
        <div>
          <h4 class="text-xs font-medium text-subtle uppercase tracking-wide mb-1">File Storage</h4>
          <div class="text-sm space-y-1">
            <% if operation.duration > 1000 %>
              <div class="text-red-600"><%= lucide_icon 'triangle-alert', width: '16', class: 'inline-block' %> Slow storage operation (>1s)</div>
            <% elsif operation.duration > 500 %>
              <div class="text-orange-600">âš¡ Moderate storage (>500ms)</div>
            <% else %>
              <div class="text-green-600"><%= lucide_icon 'check', width: '16', class: 'inline-block' %> Fast storage</div>
            <% end %>
            <div class="text-xs text-subtle">
              Active Storage operation time
            </div>
          </div>
        </div>

      <% else %>
        <div>
          <h4 class="text-xs font-medium text-subtle uppercase tracking-wide mb-1">Performance</h4>
          <div class="text-sm">
            <% if operation.duration > 100 %>
              <div class="text-orange-600">âš¡ Duration: <%= operation.duration.round(2) %>ms</div>
            <% else %>
              <div class="text-green-600"><%= lucide_icon 'check', width: '16', class: 'inline-block' %> Duration: <%= operation.duration.round(2) %>ms</div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if operation.codebase_location.present? && !%w[template partial layout].include?(operation.operation_type) %>
        <div>
          <h4 class="text-xs font-medium text-subtle uppercase tracking-wide mb-1">Source Location</h4>
          <div class="text-xs font-mono bg-gray-50 p-2 rounded border text-wrap break-all">
            <%= operation.codebase_location.split('/').last(3).join('/') %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="border-t pt-3">
      <div class="text-xs text-subtle">
        ðŸ’¡ <strong>Tips:</strong>
        <% case operation.operation_type %>
        <% when "sql" %>
          Check for missing indexes, N+1 queries, or overly complex joins.
        <% when "controller" %>
          Look for heavy computation, multiple database calls, or inefficient logic.
        <% when "template", "partial", "layout" %>
          Consider caching, reducing database calls in views, or simplifying logic.
        <% when "http" %>
          Consider caching responses, using background jobs, or optimizing external service calls.
        <% when "cache_read", "cache_write" %>
          Review cache key complexity and storage backend performance.
        <% else %>
          Monitor this operation for performance patterns and consider optimization.
        <% end %>
      </div>
    </div>
  </div>
</div>
