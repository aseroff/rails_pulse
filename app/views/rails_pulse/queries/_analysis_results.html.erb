<div class="row">
  <div>
    <!-- Query Characteristics -->
    <% if query.query_stats.present? %>
      <h5>Query Characteristics</h5>
      <dl class="descriptive-list mbs-4">
        <dt>Last Analyzed</dt>
        <dd><%= time_ago_in_words(query.analyzed_at) %></dd>
        <dt>Query Type</dt>
        <dd><%= query.query_stats['query_type'] %></dd>
        <dt>Tables</dt>
        <dd><%= query.query_stats['table_count'] || 0 %></dd>
        <dt>Joins</dt>
        <dd><%= query.query_stats['join_count'] || 0 %></dd>
        <dt>
          Complexity Score
          <div data-controller="rails-pulse--popover" data-rails-pulse--popover-placement-value="bottom-start" style="display: inline-block; margin-left: 4px;">
            <a href="#"
              data-rails-pulse--popover-target="button"
              data-action="rails-pulse--popover#toggle"
              data-popovertarget="complexity-score-popover"
              style="color: var(--gray-500); vertical-align: top;">
              <%= rails_pulse_icon 'info', height: "14px" %>
            </a>

            <div popover class="popover card" data-rails-pulse--popover-target="menu" style="max-width: 22rem">
              <div class="flex flex-col">
                <h3 class="font-semibold leading-none mbe-2 uppercase text-sm">Complexity Score</h3>
                <p class="text-sm text-subtle mbe-3">
                  A calculated score representing query complexity based on multiple factors:
                </p>
                <ul class="text-sm text-subtle" style="list-style-type: disc; padding-left: 16px; margin: 0;">
                  <li>Tables: +2 points per table</li>
                  <li>Joins: +3 points per join</li>
                  <li>WHERE conditions: +1 point per condition, +2 per function</li>
                  <li>UNIONs: +4 points each</li>
                  <li>Subqueries: +5 points each</li>
                </ul>
                <p class="text-sm text-subtle mbs-3">
                  Higher scores indicate more complex queries that may need optimization.
                </p>
              </div>
            </div>
          </div>
        </dt>
        <dd><%= query.query_stats['estimated_complexity'] || 0 %></dd>
        <dt>Has LIMIT</dt>
        <dd><%= query.query_stats['has_limit'] ? 'Yes' : 'No' %></dd>
        <dt>Has ORDER BY</dt>
        <dd><%= query.query_stats['has_order_by'] ? 'Yes' : 'No' %></dd>
        <dt>Has GROUP BY</dt>
        <dd><%= query.query_stats['has_group_by'] ? 'Yes' : 'No' %></dd>
        <dt>Has Subqueries</dt>
        <dd><%= query.query_stats['has_subqueries'] ? 'Yes' : 'No' %></dd>
      </dl>
    <% end %>
  </div>

  <div>
    <!-- Execution Analysis -->
    <% if query.backtrace_analysis.present? %>
      <h5>Execution Analysis</h5>
      <dl class="descriptive-list mbs-4">
        <dt>Total Executions</dt>
        <dd><%= query.backtrace_analysis['total_executions'] || 0 %></dd>
        <dt>Unique Locations</dt>
        <dd><%= query.backtrace_analysis['unique_locations'] || 0 %></dd>
        <dt>Execution Frequency</dt>
        <dd><%= query.backtrace_analysis['execution_frequency'] || 0 %>/hour</dd>
        <dt>Most Common Location</dt>
        <dd><code><%= query.backtrace_analysis['most_common_location']['location'] || 'N/A' %></code></dd>
        <dt>N+1 Pattern Detected</dt>
        <dd>
          <% if query.backtrace_analysis['potential_n_plus_one'] %>
            Yes
          <% else %>
            No
          <% end %>
        </dd>
      </dl>
    <% end %>
  </div>
</div>


<!-- Issues Summary -->
<% if query.issues.present? && query.issues.any? %>
  <hr class="mb-4" />
  <h3 class="text-lg bold">Issues Detected</h3>
  <ul style="list-style-type: disc; padding-left: 20px;">
    <% query.issues.each do |issue| %>
      <li><%= issue['description'] %></li>
    <% end %>
  </ul>
<% end %>


<!-- Suggestions -->
<% if query.suggestions.present? && query.suggestions.any? %>
  <hr class="mb-4" />
  <h3 class="text-lg bold">Optimization Suggestions</h3>
  <ul style="list-style-type: disc; padding-left: 20px;">
    <% query.suggestions.each do |suggestion| %>
      <li>
        <%= suggestion['action'] %>.
        <%= suggestion['benefit'] if suggestion['benefit'].present? %>
      </li>
    <% end %>
  </ul>
<% end %>

<!-- EXPLAIN Plan -->
<% if query.explain_plan.present? %>
  <hr class="mb-4" />
  <h3 class="text-lg bold">Execution Plan</h3>
  <pre class="text-sm" style="overflow: scroll"><%= query.explain_plan %></pre>
<% end %>
