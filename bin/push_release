#!/usr/bin/env bash
# frozen_string_literal: true

# push_release - Push commits and tags to GitHub and optionally wait for CI
#
# Usage:
#   bin/push_release [--wait-ci]
#   bin/push_release --help

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Help
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  echo "Usage: bin/push_release [--wait-ci]"
  echo ""
  echo "Pushes commits and tags to GitHub."
  echo ""
  echo "Options:"
  echo "  --wait-ci    Wait for GitHub Actions CI to complete"
  echo "               Requires 'gh' CLI tool to be installed"
  echo ""
  echo "Example:"
  echo "  bin/push_release"
  echo "  bin/push_release --wait-ci"
  exit 0
fi

WAIT_CI=false
if [ "$1" = "--wait-ci" ]; then
  WAIT_CI=true

  # Check if gh CLI is installed
  if ! command -v gh &> /dev/null; then
    echo -e "${YELLOW}⚠${NC}  Warning: 'gh' CLI not installed, cannot wait for CI"
    echo "Install with: brew install gh"
    WAIT_CI=false
  fi
fi

echo -e "${BLUE}↑ Pushing to GitHub${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo -e "Branch: ${GREEN}$BRANCH${NC}"

# Push commits
echo -e "${BLUE}⚙️  Pushing commits...${NC}"
git push origin "$BRANCH"
echo -e "  ${GREEN}✓${NC} Commits pushed"

# Push tags
echo -e "${BLUE}⚙️  Pushing tags...${NC}"
git push origin --tags
echo -e "  ${GREEN}✓${NC} Tags pushed"

echo ""
echo -e "${GREEN}✅ Push complete!${NC}"

# Wait for CI if requested
if [ "$WAIT_CI" = true ]; then
  echo ""
  echo -e "${BLUE}⏳ Waiting for CI to complete...${NC}"
  echo ""

  # Get the latest commit SHA
  COMMIT_SHA=$(git rev-parse HEAD)

  # Wait for workflow runs to start (GitHub takes a moment to trigger them)
  echo "Waiting for workflow runs to start..."
  sleep 10

  # Watch CI status with better error handling
  echo "Watching CI status..."
  echo ""

  # Use gh run watch and capture exit code
  if gh run watch --exit-status 2>&1; then
    echo ""
    echo -e "${GREEN}✅ All CI checks passed!${NC}"
  else
    EXIT_CODE=$?
    echo ""

    # Check actual status via API to confirm
    ACTUAL_STATUS=$(gh run list --commit "$COMMIT_SHA" --json conclusion --jq '.[0].conclusion' 2>/dev/null)

    if [ "$ACTUAL_STATUS" = "success" ]; then
      echo -e "${GREEN}✅ CI checks passed (verified via API)${NC}"
      echo -e "${YELLOW}Note: gh run watch exited with code $EXIT_CODE but workflow succeeded${NC}"
    else
      echo -e "${RED}❌ CI checks failed!${NC}"
      echo "Status: $ACTUAL_STATUS"
      echo ""
      echo "View details:"
      echo "  gh run list --commit $COMMIT_SHA"
      echo "  https://github.com/railspulse/rails_pulse/actions"
      exit 1
    fi
  fi
fi

echo ""
echo "View on GitHub: https://github.com/railspulse/rails_pulse/actions"
